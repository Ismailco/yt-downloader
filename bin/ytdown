#!/usr/bin/env node

const path = require('path');
const os = require('os');

function loadDownloader() {
  try {
    return require('../dist/lib/downloader');
  } catch {
    try {
      require('ts-node/register');
      return require('../lib/downloader');
    } catch {
      throw new Error(
        'Unable to load downloader. Run `pnpm exec tsc -p tsconfig.build.json` first, or install dev dependencies.',
      );
    }
  }
}

const { downloadVideo, downloadPlaylist } = loadDownloader();

function printUsage() {
  console.log('Usage: ytdown [-v VIDEO_URL | -p PLAYLIST_URL]');
  console.log('Example: ytdown -v https://www.youtube.com/watch?v=dQw4w9WgXcQ');
  console.log('Example: ytdown -p https://www.youtube.com/playlist?list=PLxxx');
}

async function run() {
  const args = process.argv.slice(2);
  if (args.length !== 2) {
    printUsage();
    process.exitCode = 1;
    return;
  }

  const [flag, url] = args;
  const baseOutputPath = path.join(os.homedir(), 'Movies', 'Youtube_Downloader');

  if (flag === '-v') {
    process.stdout.write('Starting video download...\n');
    try {
      const result = await downloadVideo(url, baseOutputPath, (percent, message) => {
        const pct = Math.min(100, percent || 0).toFixed(0);
        const label = message ? message.substring(0, 80) : 'Downloading video...';
        process.stdout.write(`\r${pct}% ${label}`);
      });
      process.stdout.write('\nVideo downloaded successfully.\n');
      console.log(`Saved to: ${result.filePath}`);
    } catch (error) {
      process.stdout.write('\n');
      console.error(error && error.message ? error.message : String(error));
      process.exitCode = 1;
    }
    return;
  }

  if (flag === '-p') {
    process.stdout.write('Starting playlist download...\n');
    try {
      const result = await downloadPlaylist(url, baseOutputPath, ({ videoIndex, percent, message }) => {
        const pct = Math.min(100, percent || 0).toFixed(0);
        const label = message ? message.substring(0, 80) : `Processing video #${videoIndex + 1}`;
        process.stdout.write(`\r${pct}% ${label}`);
      });
      process.stdout.write('\nPlaylist downloaded successfully.\n');
      console.log(`Folder: ${result.folderPath}`);
      console.log(`Total files: ${result.files.length}`);
    } catch (error) {
      process.stdout.write('\n');
      console.error(error && error.message ? error.message : String(error));
      process.exitCode = 1;
    }
    return;
  }

  console.log('Invalid flag. Use -v for video or -p for playlist.');
  printUsage();
  process.exitCode = 1;
}

run();
